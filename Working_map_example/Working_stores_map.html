<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>Food Access Map</title>
  <meta charset="UTF-8">


  <link rel="stylesheet" type="text/css" href="dc.css">
  <link rel="stylesheet" type="text/css" href="leaflet.css">
  <link rel="stylesheet" type="text/css" href="leaflet_Crossfilter.css">
  <link rel="stylesheet" type="text/css" href="bootstrap.css">
  <link rel="stylesheet" type="text/css" href="CSS_Styles.css">
  <link rel="stylesheet" type="text/css" href="main.css">
    <!-- added code for heatmap -->
    <!-- <link rel="stylesheet" href="heatmap/styles_leaflet_heatmap.css">
    <link rel="stylesheet" href="heatmap/MarkerCluster.css">
    <link rel="stylesheet" href="heatmap/MarkerCluster.Default.css"> -->

<!-- uptappd -->
 <script type="text/javascript" src="d3.js"></script>
  <script type="text/javascript" src="crossfilter.js"></script>
  <script type="text/javascript" src="dc.js"></script>
  <script type="text/javascript" src="leaflet_Crossfilter.js"></script>
  <script type="text/javascript" src="underscore-min.js"></script>
   <!-- added code for heatmap  -->
   <!-- <script src="heatmap/leaflet_1.8.0.js"></script>
   <script src="heatmap/heatmap_v2.0.5.js"></script>
   <script src="heatmap/leaflet-heatmap.js"></script>
   <script src="heatmap/leaflet.markercluster.js"></script> -->



</head>

<body>
  <div class="container-fluid">
    <div class="row">
      <div class="col-xs-12 dc-data-count dc-chart" id="data-count">
        <h2>Store Locator
          <small>
            <span class="filter-count"></span> selected out of <span class="total-count"></span> records |
            <a id="all" href="#">Reset All</a>
            </span>
          </small>
        </h2>
      </div>
    </div>
    <div class="row" id="control-row">
      <div class="col-xs-2 pie-chart">
        <h4>Store Type <small><a id="store"  href="#">reset</a></small></h4>
        <!-- *** troubleshoot line 55 code add to get working chart chart-ring-store not year -->
        <div class="dc-chart" id="chart-ring-store"></div>
      </div>
      <div class="col-xs-2 pie-chart">
        <h4>County <small><a id="county" href="#">reset</a></small></h4>
        <!-- *** troubleshoot line 55 code add to get working chart chart-ring-store not year -->
        <div class="dc-chart" id="chart-ring-county"></div>
      </div>
      <!-- <div class="col-xs-2 pie-chart">
        <h4>Month <small><a id="month" href="#">reset</a></small></h4>
        <div class="dc-chart" id="chart-ring-month"></div>
      </div>
      <div class="col-xs-2 pie-chart">
        <h4>Day <small><a id="day">reset</a></small></h4>
        <div id="chart-ring-day" class="dc-chart"></div>
      </div>
      <div class="col-xs-6"> -->
        </div>
        <h4>Breweries</h4>
        <div id="mapId2"></div>
        <div class ="col-xs-12 col-xs-offset-6"></div>
      </div>
    </div>
    <!-- <div class="row">
      <div class="col-xs-6 col-md-3">
        <div class="dc-chart" id="chart-rating-count"></div>
      </div>
      <div class="col-xs-6 col-md-3">
        <div class="dc-chart" id="chart-community-rating-count"></div>
      </div>
      <div class="col-xs-6 col-md-3">
        <div class="dc-chart" id="chart-abv-count"></div>
      </div>
      <div class="col-xs-6 col-md-3">
        <div class="dc-chart" id="chart-ibu-count"></div>
      </div>
    </div> -->

    <!-- *** to show table*** -->
    <!-- <div class="row">
      <div class="col-xs-12">
        <table class="table table-bordered table-striped" id="data-table">
          <thead>
            <tr class="header">
              <th>Brewery</th>
              <th>Beer</th>
              <th>Style</th>
              <th>My Rating</th>
              <th>Community Rating</th>
              <th>ABV %</th>
              <th>IBU</th>
            </tr>
          </thead>
        </table>
      </div>
    </div> -->
  </div>
  <script>

    /* instantiate and configure map */
    // var map = L.map('map');
    // var breweryMarkers = new L.FeatureGroup();

    // L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
    //   id: '<your id here>',
    //   accessToken: '<your token here>',
    //   maxZoom: 16
    // } ).addTo(map);
    
    
    // var map = L.map('map');

    // var breweryMarkers = new L.FeatureGroup();

    // var USGS_USImagery = L.tileLayer('https://basemap.nationalmap.gov/arcgis/rest/services/USGSImageryOnly/MapServer/tile/{z}/{y}/{x}', {
    //   maxZoom: 20,
    //   attribution: 'Tiles courtesy of the <a href="https://usgs.gov/">U.S. Geological Survey</a>'
    // });


    // USGS_USImagery.addTo(map); 

    // ***start copying code here
   
    // *** added heatmap: start
    // var marker = L.circleMarker([latitude, longitude], { 
    //         radius: 8,
    //         fillColor: fillColor_Var,
    //         color: "black",
    //         weight: 1,
    //         opacity: 1,
    //         fillOpacity: 0.8
    //       });
          
    // window.onload = function () {
      // *** added heatmap: end

    var map = L.map('mapId2').setView([35.260310, -106.597695],10);

    var breweryMarkers = new L.FeatureGroup();

        //replace the code below from the Plain JavaScript from the map style you choose
        //at http://leaflet-extras.github.io/leaflet-providers/preview/

        var USGS_USImagery = L.tileLayer('https://basemap.nationalmap.gov/arcgis/rest/services/USGSImageryOnly/MapServer/tile/{z}/{y}/{x}', {
          maxZoom: 16,
          attribution: 'Tiles courtesy of the <a href="https://usgs.gov/">U.S. Geological Survey</a>'
        });

        //change the varialbe "OpenTopoMap" according to the map style you choose
        //It is the varialbe between "var" and "= L.titleLayer(..."  in Line 28 in this script
     
USGS_USImagery.addTo(map); 
// *** added heatmap: start
// USGS_USImagery.addTo(map);
            //   var cfg = {
            //     radius: .005,
            //     maxOpacity: .8,
            //     scaleRadius: true,
            //     useLocalExtrema: true,
            //     latField: "Y",
            //     lngField: "X",
            //     name: "Name",

            //   };
            //   var heatmapLayer = new HeatmapOverlay(cfg);
            //   heatmapLayer.setData('Storesfiltered.csv');
            //   map.addLayer(heatmapLayer);
            // };
            
            

              // *** added heatmap: end


    /* Parse JSON file, create charts, draw markers on map */
    
    d3.csv('Storesfiltered.csv', function (error, data) {


//  *** tailored to project stop 

      // d3.json('Storesfiltered2.geojson', function (error, data) {
      // var beerData = data.response.beers.items;
// ***check full date***

//  *** start process



      // var fullDateFormat = d3.time.format('%a, %d %b %Y %X %Z');
      // var yearFormat = d3.time.format('%Y');
      // var monthFormat = d3.time.format('%b');
      // var dayOfWeekFormat = d3.time.format('%a');

      // normalize/parse data so dc can correctly sort & bin them
      // I like to think of each "d" as a row in a spreadsheet
      // _.each(beerData, function (d) {
      //   d.count = +d.count;
      //   // round to nearest 0.25
      //   // d.rating_score = Math.round(+d.rating_score * 4) / 4;
      //   // d.beer.rating_score = Math.round(+d.beer.rating_score * 4) / 4;
      //   // // round to nearest 0.5
      //   // d.beer.beer_abv = Math.round(+d.beer.beer_abv * 2) / 2;
      //   // // round to nearest 10
      //   // d.beer.beer_ibu = Math.floor(+d.beer.beer_ibu / 10) * 10;

      //   d.first_had_dt = fullDateFormat.parse(d.first_had);
      //   d.first_had_year = +yearFormat(d.first_had_dt);
      //   // d.first_had_month = monthFormat(d.first_had_dt);
        // d.first_had_day = dayOfWeekFormat(d.first_had_dt);
      // });

      
      // set crossfilter
      var ndx = crossfilter(data);

      // create dimensions (x-axis values)

      // *** altered code to specific field adapted to stores
    

      var storeDim = ndx.dimension(function (d) { return d["Type_1"];});
      var countyDim = ndx.dimension(function (d) { return d["County"];});
        // dc.pluck: short-hand for same kind of anon. function we used for yearDim
        // monthDim = ndx.dimension(dc.pluck('first_had_month')),
        // dayOfWeekDim = ndx.dimension(dc.pluck('first_had_day')),
        // ratingDim = ndx.dimension(dc.pluck('rating_score')),
        // commRatingDim = ndx.dimension(function (d) { return d.beer.rating_score; }),
        // abvDim = ndx.dimension(function (d) { return d.beer.beer_abv; }),
        // ibuDim = ndx.dimension(function (d) { return d.beer.beer_ibu; }),
        allDim = ndx.dimension(function (d) { return d; })
        ;

      // create groups (y-axis values)
      var all = ndx.groupAll();
      // var countPerYear = yearDim.group().reduceCount();
        // countPerMonth = monthDim.group().reduceCount(),
        // countPerDay = dayOfWeekDim.group().reduceCount(),
        // countPerRating = ratingDim.group().reduceCount(),
        // countPerCommRating = commRatingDim.group().reduceCount(),
        // countPerABV = abvDim.group().reduceCount(),
        // countPerIBU = ibuDim.group().reduceCount();

        // ***tailored code 

        var storeGroup = storeDim.group().reduceCount();
        var countyGroup = countyDim.group().reduceCount();

      // specify charts

      var storeChart = dc.pieChart('#chart-ring-store');
      var countyChart = dc.pieChart('#chart-ring-county');
      // var yearChart = dc.pieChart('#chart-ring-year'),

      // ***tailored to project 



        // monthChart = dc.pieChart('#chart-ring-month'),
        // dayChart = dc.pieChart('#chart-ring-day'),
        // ratingCountChart = dc.barChart('#chart-rating-count'),
        // commRatingCountChart = dc.barChart('#chart-community-rating-count'),
        // abvCountChart = dc.barChart('#chart-abv-count'),
        // ibuCountChart = dc.barChart('#chart-ibu-count'),
        dataCount = dc.dataCount('#data-count'),
      dataTable = dc.dataTable('#data-table');

      // yearChart
      //   .width(150)
      //   .height(150)
      //   .dimension(yearDim)
      //   .group(countPerYear)
      //   .innerRadius(20);

        // *** tailored to project 


      storeChart
        .width(150)
        .height(150)
        .dimension(storeDim)
        .group(storeGroup)
        .innerRadius(20);

        countyChart
        .width(150)
        .height(150)
        .dimension(countyDim)
        .group(countyGroup)
        .innerRadius(20);

      // monthChart
      //   .width(150)
      //   .height(150)
      //   .dimension(monthDim)
      //   .group(countPerMonth)
      //   .innerRadius(20)
      //   .ordering(function (d) {
      //     var order = {
      //       'Jan': 1, 'Feb': 2, 'Mar': 3, 'Apr': 4,
      //       'May': 5, 'Jun': 6, 'Jul': 7, 'Aug': 8,
      //       'Sep': 9, 'Oct': 10, 'Nov': 11, 'Dec': 12
      //     };
      //     return order[d.key];
      //   });

      // dayChart
      //   .width(150)
      //   .height(150)
      //   .dimension(dayOfWeekDim)
      //   .group(countPerDay)
      //   .innerRadius(20)
      //   .ordering(function (d) {
      //     var order = {
      //       'Mon': 0, 'Tue': 1, 'Wed': 2, 'Thu': 3,
      //       'Fri': 4, 'Sat': 5, 'Sun': 6
      //     }
      //     return order[d.key];
      //   }
      //   );

      // ratingCountChart
      //   .width(300)
      //   .height(180)
      //   .dimension(ratingDim)
      //   .group(countPerRating)
      //   .x(d3.scale.linear().domain([0, 5.2]))
      //   .elasticY(true)
      //   .centerBar(true)
      //   .barPadding(5)
      //   .xAxisLabel('My rating')
      //   .yAxisLabel('Count')
      //   .margins({ top: 10, right: 20, bottom: 50, left: 50 });
      // ratingCountChart.xAxis().tickValues([0, 1, 2, 3, 4, 5]);

      // commRatingCountChart
      //   .width(300)
      //   .height(180)
      //   .dimension(commRatingDim)
      //   .group(countPerCommRating)
      //   .x(d3.scale.linear().domain([0, 5.2]))
      //   .elasticY(true)
      //   .centerBar(true)
      //   .barPadding(5)
      //   .xAxisLabel('Community rating')
      //   .yAxisLabel('Count')
      //   .margins({ top: 10, right: 20, bottom: 50, left: 50 });
      // commRatingCountChart.xAxis().tickValues([0, 1, 2, 3, 4, 5]);

      // abvCountChart
      //   .width(300)
      //   .height(180)
      //   .dimension(abvDim)
      //   .group(countPerABV)
      //   .x(d3.scale.linear().domain([-0.2, d3.max(beerData, function (d) { return d.beer.beer_abv; }) + 0.2]))
      //   .elasticY(true)
      //   .centerBar(true)
      //   .barPadding(2)
      //   .xAxisLabel('Alcohol By Volume (%)')
      //   .yAxisLabel('Count')
      //   .margins({ top: 10, right: 20, bottom: 50, left: 50 });

      // ibuCountChart
      //   .width(300)
      //   .height(180)
      //   .dimension(ibuDim)
      //   .group(countPerIBU)
      //   .x(d3.scale.linear().domain([-2, d3.max(beerData, function (d) { return d.beer.beer_ibu; }) + 2]))
      //   .elasticY(true)
      //   .centerBar(true)
      //   .barPadding(5)
      //   .xAxisLabel('International Bitterness Units')
      //   .yAxisLabel('Count')
      //   .xUnits(function (d) { return 5; })
      //   .margins({ top: 10, right: 20, bottom: 50, left: 50 });

      dataCount
        .dimension(ndx)
        .group(all);

      dataTable
        .dimension(allDim)
        .group(function (d) { return 'dc.js insists on putting a row here so I remove it using JS'; })
        .size(100)
        .columns([
          // function (d) { return d.brewery.brewery_name; },
          // function (d) { return d.beer.beer_name; },
          // function (d) { return d.beer.beer_style; },
          // function (d) { return d.rating_score; },
          // function (d) { return d.beer.rating_score; },
          // function (d) { return d.beer.beer_abv; },
          // function (d) { return d.beer.beer_ibu; }
        ])

        //  alter code to city adapted to stores 


        .sortBy(dc.pluck('Type_1'))
        .order(d3.descending)
        .on('renderlet', function (table) {
          // each time table is rendered remove nasty extra row dc.js insists on adding
          table.select('tr.dc-table-group').remove();
//  myFunctionHolder.pointToCircle = function (feature, latlng) {
      //     var geojsonMarkerOptions = {
      //       radius: 8,
      //       //fillColor: "#F46B06",
      //       fillColor: "yellow",
      //       color: "black",
      //       weight: 1,
      //       opacity: 1,
      //       fillOpacity: 0.8
      //     };
      //     var circleMarker = L.circleMarker(latlng, geojsonMarkerOptions);
      //     return circleMarker;
          // update map with breweries to match filtered data
          // breweryMarkers.clearLayers();
          // _.each(allDim.top(Infinity), function (d) {
          //   var loc = d.brewery.location;
          //   var name = d.brewery.brewery_name;
          //   var marker = L.circleMarker([loc.lat, loc.lng], { 
          //   radius: 8,
          //   fillColor: "#F46B06",
          //   // fillColor: "yellow",
          //   color: "black",
          //   weight: 1,
          //   opacity: 1,
          //   fillOpacity: 0.8});
          //   marker.bindPopup("<p>" + name + " " + loc.brewery_city + " " + loc.brewery_state + "</p>");
          //   breweryMarkers.addLayer(marker);
            
            //***tailored popup to project: Start 
           
            breweryMarkers.clearLayers();
          _.each(allDim.top(Infinity), function (d) { 
            var latitude = d["Y"];
            var longitude = d["X"];
            var fullAddress = d["FullAddres"];
            var name = d["Name"];
            var city = d["City_1"];
            var county = d["County"];
            var storeType = d["Type_1"];

            // Types of stores Bakery Specialty, Combination Grocery/Other, Farmers' Market, 
            //  Food Buying Co-op, Fruits/Veg Specialty, Large Grocery Store,
            //   Meat/Poultry Specialty, Medium Grocery Store, Small Grocery Store, 
            //   Super Store, Supermarket, Unknown, Wholesaler

            if (storeType == "Bakery Specialty") {
                                fillColor_Var = "#fb9a99";
                            } else if (storeType == "Combination Grocery/Other") {
                                fillColor_Var = "#e31a1c";
                            } else if (storeType == "Farmers' Market") {
                                fillColor_Var = "#fdbf6f";
                              } else if (storeType == "Food Buying Co-op") {
                                fillColor_Var = "#ff7f00";
                            } else if (storeType == "Fruits/Veg Specialty") {
                                fillColor_Var = "#cab2d6";
                            }  else if (storeType == " Large Grocery Store") {
                                fillColor_Var = "#0096FF";
                            } else if (storeType == "Meat/Poultry Specialty") {
                                fillColor_Var = "#40E0D0";
                            }
                           else if (storeType == "Medium Grocery Store") {
                                fillColor_Var = "#43a2ca";
                            } else if (storeType == "Small Grocery Store") {
                                fillColor_Var = "#0868ac";
                              } else if (storeType == "Super Store") {
                                fillColor_Var = "#7bccc4";
                            } else if (storeType == "Supermarket") {
                                fillColor_Var = "#bae4bc";
                            }  else if (storeType == "Unknown") {
                                fillColor_Var = "#0096FF";
                            } else if (storeType == "Wholesaler") {
                                fillColor_Var = "#f0f9e8";
                            }
                             else {
                                fillColor_Var = "#B9C0C3";
                            }
                            

                           
 //***tailored popup to project: end



            // ***review for correct format to populate cordinates

// *** commented out marker 
            var marker = L.circleMarker([latitude, longitude], { 
            radius: 8,
            fillColor: fillColor_Var,
            color: "black",
            weight: 1,
            opacity: 1,
            fillOpacity: 0.8
          });
          

          //   marker.bindPopup("<p>" + name + " " + fullAddress + " " + city + " " + county + " " + storeType + " " + "</p>");
          //   breweryMarkers.addLayer(marker);
          // });


          // *** Modified popup display: start
          marker.bindPopup(
            "<p>" + "Name: " + name + "<br>" + "Address: " + fullAddress + "<br> " + "City: " +city + "<br> " + "County: " + county + "<br> " + "Source Type: " + storeType + "<br> " + "</p>");
          breweryMarkers.addLayer(marker);
        });

          // *** Modified popup display: end 
          
          // *** tailor variable to project breweryMarkers
          map.addLayer(breweryMarkers);
          map.fitBounds(breweryMarkers.getBounds());
        });

      // register handlers
      d3.selectAll('a#all').on('click', function () {
        dc.filterAll();
        dc.renderAll();
      });

      d3.selectAll('a#store').on('click', function () {
        storeChart.filterAll();
        dc.redrawAll();
      });

      d3.selectAll('a#county').on('click', function () {
        countyChart.filterAll();
        dc.redrawAll();
      });


      // d3.selectAll('a#month').on('click', function () {
      //   monthChart.filterAll();
      //   dc.redrawAll();
      // });

      // d3.selectAll('a#day').on('click', function () {
      //   dayChart.filterAll();
      //   dc.redrawAll();
      // });

      // showtime!
      dc.renderAll();

    })

  </script>
</body>

